<div class="d-flex justify-content-between align-items-center mb-4 fade-in">
  <h3 class="fw-bold text-danger">Barang Keluar</h3>
</div>

<div class="card border-0 shadow-sm p-4 mb-4 fade-in" style="border-radius: 12px;">
  <div class="row g-3">
    <div class="col-md-3">
      <label class="form-label text-muted">Tanggal</label>
      <input type="date" id="bk_tgl" class="form-control">
    </div>
    <div class="col-md-5">
      <label class="form-label text-muted">Kode Barang</label>
      <div class="input-group">
        <input type="text" id="bk_kode" class="form-control" placeholder="Scan atau Ketik...">
        <button class="btn btn-outline-danger" onclick="bk_startScan()"><i class="material-icons">qr_code_scanner</i></button>
      </div>
    </div>
    <div class="col-md-4 d-grid">
      <button class="btn btn-secondary text-white" onclick="bk_cekBarang()" style="margin-top: 30px;">
        <i class="material-icons" style="font-size:16px; vertical-align:text-bottom;">search</i> Cek Barang
      </button>
    </div>
  </div>

  <div id="bk_info" class="row mt-3 p-3 bg-light rounded border mx-1" style="display:none;">
    <div class="col-md-4"><strong>Nama:</strong> <span id="bk_nama" class="text-danger">-</span></div>
    <div class="col-md-4"><strong>Sisa Stok:</strong> <span id="bk_stok" class="badge bg-warning text-dark">-</span></div>
    <div class="col-md-4"><strong>Satuan:</strong> <span id="bk_satuan">-</span></div>
  </div>

  <div class="row g-3 mt-2">
    <div class="col-md-3">
      <label class="form-label text-muted">Jumlah Keluar</label>
      <input type="number" id="bk_jml" class="form-control" min="1">
    </div>
    <div class="col-md-3">
      <label class="form-label text-muted">Gudang Asal</label>
      <select id="bk_gudang" class="form-select">
        <option>Gudang 1</option><option>Gudang 2</option><option>Gudang 3</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label text-muted">Penanggung Jawab</label>
      <input type="text" id="bk_pj" class="form-control" placeholder="Nama Staff">
    </div>
    <div class="col-md-3 d-grid align-items-end">
      <button class="btn btn-danger w-100 fw-bold" onclick="bk_simpan()">
        <i class="material-icons" style="font-size:18px; vertical-align:bottom;">outbox</i> KELUARKAN
      </button>
    </div>
  </div>
</div>

<div class="card border-0 shadow-sm p-4 fade-in" style="border-radius: 12px;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Riwayat Keluar</h5>
    <input type="text" id="bk_search" class="form-control form-control-sm w-auto" placeholder="Cari..." onkeyup="bk_loadData()">
  </div>
  
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr><th>Tanggal</th><th>Kode</th><th>Nama</th><th>Jml</th><th>Gudang</th><th>PJ</th><th>Aksi</th></tr>
      </thead>
      <tbody id="bk_table"></tbody>
    </table>
  </div>
  
  <div class="d-flex justify-content-end gap-2 mt-3">
    <button class="btn btn-sm btn-outline-secondary" onclick="bk_nav(-1)">Prev</button>
    <span id="bk_page_info" class="align-self-center text-muted small">Page 1</span>
    <button class="btn btn-sm btn-outline-secondary" onclick="bk_nav(1)">Next</button>
  </div>
</div>

<div class="modal fade" id="bk_scanModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Scanner Keluar</h5>
        <button type="button" class="btn-close btn-close-white" onclick="bk_stopScan()"></button>
      </div>
      <div class="modal-body p-0 bg-dark"><div id="bk_reader" style="width:100%"></div></div>
    </div>
  </div>
</div>

<script>
  var bk_page = 1;
  var bk_scanner = null;

  (function() {
    document.getElementById('bk_tgl').valueAsDate = new Date();
    bk_loadData();
  })();

  function bk_cekBarang() {
    var kode = document.getElementById('bk_kode').value;
    if(!kode) return Swal.fire('Info', 'Isi kode barang', 'info');
    
    google.script.run.withSuccessHandler(function(p) {
      if(p) {
        document.getElementById('bk_nama').innerText = p.nama;
        document.getElementById('bk_stok').innerText = p.stok;
        document.getElementById('bk_satuan').innerText = p.satuan;
        document.getElementById('bk_info').style.display = 'flex';
      } else {
        Swal.fire('404', 'Barang tidak ditemukan', 'error');
        document.getElementById('bk_info').style.display = 'none';
      }
    }).getProdukByBarcode(kode);
  }

  function bk_simpan() {
    var d = {
      tgl: document.getElementById('bk_tgl').value,
      kode: document.getElementById('bk_kode').value,
      jml: document.getElementById('bk_jml').value,
      gudang: document.getElementById('bk_gudang').value,
      pj: document.getElementById('bk_pj').value
    };

    if(!d.kode || !d.jml || !d.pj) return Swal.fire('Warning', 'Lengkapi data!', 'warning');

    Swal.showLoading();
    google.script.run.withSuccessHandler(function(res) {
      Swal.close();
      if(res.success) {
        Swal.fire('Berhasil', res.message, 'success');
        document.getElementById('bk_kode').value = '';
        document.getElementById('bk_jml').value = '';
        document.getElementById('bk_info').style.display = 'none';
        bk_loadData();
      } else {
        Swal.fire('Gagal', res.message, 'error');
      }
    }).addBarangKeluar(d.tgl, d.kode, d.jml, d.gudang, d.pj);
  }

  function bk_loadData() {
    var s = document.getElementById('bk_search').value;
    google.script.run.withSuccessHandler(function(res) {
      var html = '';
      res.data.forEach(function(r) {
        html += `<tr>
          <td>${r[0]}</td><td><span class="badge bg-light text-dark border">${r[1]}</span></td>
          <td>${r[2]}</td><td class="text-danger fw-bold">-${r[7]}</td>
          <td>${r[5]}</td><td>${r[6]}</td>
          <td><button class="btn btn-sm btn-outline-danger" onclick="bk_hapus(${r[8]})"><i class="material-icons" style="font-size:16px">delete</i></button></td>
        </tr>`;
      });
      document.getElementById('bk_table').innerHTML = html || '<tr><td colspan="7" class="text-center">Kosong</td></tr>';
      document.getElementById('bk_page_info').innerText = 'Page ' + res.currentPage;
    }).getDataBarangKeluar('', bk_page, 10, s);
  }

  function bk_hapus(idx) {
    Swal.fire({title:'Batalkan?', text:'Stok akan dikembalikan', icon:'warning', showCancelButton:true}).then((r) => {
      if(r.isConfirmed) {
        google.script.run.withSuccessHandler(res => { Swal.fire('Info', res, 'info'); bk_loadData(); }).hapusBarangKeluar(idx);
      }
    });
  }

  function bk_nav(d) {
    if(d === -1 && bk_page > 1) { bk_page--; bk_loadData(); }
    if(d === 1) { bk_page++; bk_loadData(); }
  }

  function bk_startScan() {
    new bootstrap.Modal(document.getElementById('bk_scanModal')).show();
    if(!bk_scanner) bk_scanner = new Html5Qrcode("bk_reader");
    bk_scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
      function(decoded) {
        document.getElementById('bk_kode').value = decoded;
        bk_stopScan();
        bk_cekBarang();
        var ctx = new (window.AudioContext || window.webkitAudioContext)();
        var osc = ctx.createOscillator(); osc.connect(ctx.destination);
        osc.start(); osc.stop(ctx.currentTime + 0.1);
      }
    );
  }
  
  function bk_stopScan() {
    if(bk_scanner) bk_scanner.stop().then(() => bk_scanner.clear());
    var el = document.getElementById('bk_scanModal');
    var modal = bootstrap.Modal.getInstance(el);
    if(modal) modal.hide();
  }
</script>
