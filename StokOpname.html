<div class="d-flex justify-content-between align-items-center mb-4 fade-in">
  <h3 class="fw-bold text-dark">Stok Opname</h3>
</div>

<div class="card border-0 shadow-sm p-4 mb-4 fade-in" style="border-radius: 12px;">
  <div class="row g-3">
    <div class="col-md-3">
      <label class="form-label text-muted">Tanggal Opname</label>
      <input type="date" id="so_tgl" class="form-control">
    </div>
    <div class="col-md-5">
      <label class="form-label text-muted">Kode Barang</label>
      <div class="input-group">
        <input type="text" id="so_kode" class="form-control" placeholder="Scan/Ketik Kode...">
        <button class="btn btn-outline-dark" onclick="so_startScan()"><i class="material-icons">qr_code_scanner</i></button>
      </div>
    </div>
    <div class="col-md-4 d-grid">
      <button class="btn btn-secondary text-white" onclick="so_cekBarang()" style="margin-top: 30px;">
        <i class="material-icons" style="font-size:16px;">search</i> Cek Data Sistem
      </button>
    </div>
  </div>

  <div id="so_info" class="row mt-3 p-3 bg-light rounded border mx-1" style="display:none;">
    <div class="col-md-4">
      <small class="text-muted d-block">Nama Barang</small>
      <strong id="so_nama" class="text-primary fs-5">-</strong>
    </div>
    <div class="col-md-4">
      <small class="text-muted d-block">Stok Sistem</small>
      <strong id="so_stok_sys" class="text-dark fs-5">0</strong>
    </div>
    <div class="col-md-4">
      <label class="form-label fw-bold text-success">Stok Fisik (Aktual)</label>
      <input type="number" id="so_fisik" class="form-control border-success" placeholder="Isi jumlah..." oninput="so_hitungSelisih()">
    </div>
    <div class="col-12 mt-2">
      <div class="alert alert-warning py-2 mb-0 d-flex justify-content-between">
        <span>Selisih: <strong id="so_selisih">0</strong></span>
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="so_sesuaikan">
          <label class="form-check-label" for="so_sesuaikan">Sesuaikan stok sistem dengan fisik?</label>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-3">
    <div class="col-md-6">
      <label class="form-label text-muted">Petugas</label>
      <input type="text" id="so_petugas" class="form-control">
    </div>
    <div class="col-md-6">
      <label class="form-label text-muted">Catatan</label>
      <input type="text" id="so_catatan" class="form-control">
    </div>
    <div class="col-12 d-grid mt-3">
      <button class="btn btn-dark fw-bold" onclick="so_simpan()">
        <i class="material-icons" style="vertical-align:bottom">save_alt</i> SIMPAN HASIL OPNAME
      </button>
    </div>
  </div>
</div>

<div class="card border-0 shadow-sm p-4 fade-in">
  <h5 class="mb-3">Riwayat Opname</h5>
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr><th>Tanggal</th><th>Kode</th><th>Nama</th><th>Sistem</th><th>Fisik</th><th>Selisih</th><th>Status</th></tr>
      </thead>
      <tbody id="so_table"></tbody>
    </table>
  </div>
</div>

<div class="modal fade" id="so_scanModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white"><h5>Scanner Opname</h5><button type="button" class="btn-close btn-close-white" onclick="so_stopScan()"></button></div>
      <div class="modal-body p-0"><div id="so_reader" style="width:100%"></div></div>
    </div>
  </div>
</div>

<script>
  var so_scanner = null;
  (function(){
    document.getElementById('so_tgl').valueAsDate = new Date();
    so_loadHistory();
  })();

  function so_cekBarang() {
    var kode = document.getElementById('so_kode').value;
    if(!kode) return Swal.fire('Info','Masukkan kode','info');
    google.script.run.withSuccessHandler(p => {
      if(p) {
        document.getElementById('so_nama').innerText = p.nama;
        document.getElementById('so_stok_sys').innerText = p.stok;
        document.getElementById('so_info').style.display = 'flex';
        document.getElementById('so_fisik').focus();
      } else Swal.fire('404','Barang tidak ada','error');
    }).getProdukByBarcode(kode);
  }

  function so_hitungSelisih() {
    var sys = Number(document.getElementById('so_stok_sys').innerText);
    var act = Number(document.getElementById('so_fisik').value);
    document.getElementById('so_selisih').innerText = (act - sys);
  }

  function so_simpan() {
    var d = {
      tgl: document.getElementById('so_tgl').value,
      kode: document.getElementById('so_kode').value,
      nama: document.getElementById('so_nama').innerText,
      fisik: document.getElementById('so_fisik').value,
      petugas: document.getElementById('so_petugas').value,
      catatan: document.getElementById('so_catatan').value,
      sesuaikan: document.getElementById('so_sesuaikan').checked
    };
    if(!d.fisik || !d.kode) return Swal.fire('Error','Lengkapi data fisik','warning');
    Swal.showLoading();
    google.script.run.withSuccessHandler(res => {
      Swal.fire('Sukses', res.message, 'success');
      document.getElementById('so_info').style.display = 'none';
      document.getElementById('so_kode').value = '';
      document.getElementById('so_fisik').value = '';
      so_loadHistory();
    }).simpanOpname(d);
  }

  function so_loadHistory() {
    google.script.run.withSuccessHandler(res => {
      var html = '';
      res.data.forEach(r => {
        html += `<tr><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td><td>${r[5]}</td><td class="${r[6]!=0?'text-danger fw-bold':''}">${r[6]}</td><td>${r[7]}</td></tr>`;
      });
      document.getElementById('so_table').innerHTML = html || '<tr><td colspan="7">Kosong</td></tr>';
    }).getDataOpname(1, 10);
  }

  function so_startScan() {
    new bootstrap.Modal(document.getElementById('so_scanModal')).show();
    if(!so_scanner) so_scanner = new Html5Qrcode("so_reader");
    so_scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (d) => {
      document.getElementById('so_kode').value = d;
      so_stopScan(); so_cekBarang();
    });
  }
  function so_stopScan() {
    if(so_scanner) so_scanner.stop().then(()=>so_scanner.clear());
    bootstrap.Modal.getInstance(document.getElementById('so_scanModal')).hide();
  }
</script>
