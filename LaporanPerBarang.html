<div class="d-flex justify-content-between align-items-center mb-4 fade-in">
  <h3 class="fw-bold text-primary">Kartu Stok Barang</h3>
</div>

<div class="card border-0 shadow-sm p-4 mb-4 fade-in">
  <div class="row g-3 align-items-end">
    <div class="col-md-4">
      <label class="form-label text-muted">Kode Barang</label>
      <div class="input-group">
        <input type="text" id="ks_kode" class="form-control" placeholder="Scan/Ketik Kode...">
        <button class="btn btn-outline-secondary" onclick="ks_startScan()"><i class="material-icons">qr_code_scanner</i></button>
      </div>
    </div>
    <div class="col-md-3">
      <label class="form-label text-muted">Dari Tanggal</label>
      <input type="date" id="ks_mulai" class="form-control">
    </div>
    <div class="col-md-3">
      <label class="form-label text-muted">Sampai Tanggal</label>
      <input type="date" id="ks_akhir" class="form-control">
    </div>
    <div class="col-md-2">
      <button class="btn btn-primary w-100" onclick="ks_cari()">
        <i class="material-icons" style="vertical-align:bottom">search</i> Lihat
      </button>
    </div>
  </div>
</div>

<div id="ks_result" class="card border-0 shadow-sm p-4 fade-in" style="display:none;">
  <div class="d-flex justify-content-between mb-3 border-bottom pb-2">
    <div>
      <h5 id="ks_nama_barang" class="mb-0 fw-bold">-</h5>
      <small class="text-muted">Kode: <span id="ks_kode_show"></span></small>
    </div>
    <div class="text-end">
      <small>Stok Awal</small>
      <h5 id="ks_stok_awal" class="fw-bold">0</h5>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-sm table-hover">
      <thead class="table-light">
        <tr><th>Tanggal</th><th>Keterangan</th><th class="text-success">Masuk</th><th class="text-danger">Keluar</th><th>Saldo</th></tr>
      </thead>
      <tbody id="ks_table"></tbody>
    </table>
  </div>
</div>

<div class="modal fade" id="ks_scanModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body p-0"><div id="ks_reader" style="width:100%"></div></div>
    </div>
  </div>
</div>

<script>
  var ks_scanner = null;
  (function() {
    var d = new Date();
    document.getElementById('ks_akhir').valueAsDate = d;
    d.setDate(1);
    document.getElementById('ks_mulai').valueAsDate = d;
  })();

  function ks_cari() {
    var kode = document.getElementById('ks_kode').value;
    var start = document.getElementById('ks_mulai').value;
    var end = document.getElementById('ks_akhir').value;
    if(!kode) return Swal.fire('Info','Masukkan kode barang','info');
    document.getElementById('ks_table').innerHTML = '<tr><td colspan="5" class="text-center">Memproses...</td></tr>';
    document.getElementById('ks_result').style.display = 'block';
    google.script.run.withSuccessHandler(res => {
      google.script.run.withSuccessHandler(p => {
        if(p) {
          document.getElementById('ks_nama_barang').innerText = p.nama;
          document.getElementById('ks_kode_show').innerText = p.kode;
        }
      }).getProdukByBarcode(kode);

      document.getElementById('ks_stok_awal').innerText = res.stokAwal;
      var html = '';
      if(res.data.length === 0) html = '<tr><td colspan="5" class="text-center text-muted">Tidak ada mutasi</td></tr>';
      else {
        res.data.forEach(r => {
          html += `<tr><td>${r.tgl}</td><td>${r.ket}</td><td class="text-success">${r.masuk || '-'}</td><td class="text-danger">${r.keluar || '-'}</td><td class="fw-bold">${r.saldo}</td></tr>`;
        });
      }
      document.getElementById('ks_table').innerHTML = html;
    }).getLaporanKartuStok(kode, start, end);
  }

  function ks_startScan() {
    new bootstrap.Modal(document.getElementById('ks_scanModal')).show();
    if(!ks_scanner) ks_scanner = new Html5Qrcode("ks_reader");
    ks_scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (d) => {
      document.getElementById('ks_kode').value = d;
      if(ks_scanner) ks_scanner.stop().then(()=>ks_scanner.clear());
      bootstrap.Modal.getInstance(document.getElementById('ks_scanModal')).hide();
      ks_cari();
    });
  }
</script>
